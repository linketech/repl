<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@4.1.2/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.1/build/styles/default.min.css">
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
	<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.1/build/highlight.min.js"></script>
	<script src="//cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
	<style>
		/* .ql-editor.ql-blank::before { 
			content: "Ctrl+Up/Down to browse history\A Ctrl+Enter to submit your nodejs code\A Submit empty to refresh";
		}
		.ql-editor::before {
			content: "";
		} */
		.ql-editor {
			padding: 0;
		}
		.ql-snow .ql-editor pre.ql-syntax {
			margin: 0;
			background-color: black;
			font-size: 14px;
		}
		.row {
			margin-left: 0px;
			margin-right: 0px;
		}
		.hljs {
			background-color: transparent;
		}
	</style>
	<script type="text/javascript">
		let quill = null
		function onload() {
			const textarea = document.getElementById('script')
			const editor = document.getElementById('editor')
			const form = document.getElementById('form')
			const inputList = <%=JSON.stringify(_.map(_.filter(logs, ({ type }) => type === 'input'), 'content'))%>
			let inputListCursor = inputList.length
			let cacheText = ''
			editor.addEventListener('keydown', function(e) {
				console.log('keydown', e)
				if(e.ctrlKey && e.keyCode === 13) { // ctrl + enter
					form.script.value = quill.getText()
					form.submit()
					e.preventDefault()
				} else if (e.ctrlKey && e.keyCode === 38) { // ctrl + up
					if (inputListCursor === inputList.length) {
						cacheText = quill.getText()
					}
					inputListCursor = Math.max(0, inputListCursor - 1)
					const insert = inputList[inputListCursor]
					quill.setContents([{ insert, attributes: { 'code-block': true } }])
				} else if (e.ctrlKey && e.keyCode === 40) { // ctrl + down
					inputListCursor = Math.min(inputListCursor + 1, inputList.length)
					const insert = inputListCursor === inputList.length ? cacheText : inputList[inputListCursor]
					quill.setContents([{ insert, attributes: { 'code-block': true } }])
				} else if (e.keyCode === 13) {
					// todo indent
				}
			})
			editor.addEventListener('input', function(e) {
				inputListCursor = inputList.length
			})

			quill = new Quill('#editor', {
				modules: {
					syntax: true,
					toolbar: false // [['code-block']]
				},
				theme: 'snow'
			})
			quill.setContents([{ insert: '\n', attributes: { 'code-block': true } }])
			quill.focus()
		}
		hljs.initHighlightingOnLoad()
	</script>
</head>
<body onload="onload()">
	<div class="row" style="background-color: darkslateblue;">
		<span style="margin: 8px auto; color: lightblue;">üíªÔ∏è NodeJS REPL</span>
	</div>
	<form action="" method="POST" class="form" id="form" style="background-color: black;">
		<% _.forEach(logs, ({ timestamp, content, type }) => {%>
			<div class="row">
				<div class="col-1">
					<pre style="margin: 5px"><div style="color: lightgrey; padding: .5em;"><%=moment(timestamp).format('HH:mm:ss')%></div></pre>
				</div>
				<div class="col-11">
					<pre style="margin: 5px"><code style="color: <%=type==='input'?'lightblue':'lightgrey'%>;"><%=_.escape(content)%></code></pre>
				</div>
			</div>
		<%})%>
		<textarea id="script" name="script" hidden></textarea>
	</form>
	<div id="editor" title="Ctrl+Up/Down to browse history&#10Ctrl+Enter to submit your nodejs code&#10Submit empty to refresh"></div>
</body>
</html>
