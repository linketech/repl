<!DOCTYPE html>
<html>
<head>
	<script src="https://cdn.jsdelivr.net/npm/prismjs@1.19.0/prism.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.19.0/themes/prism.css">
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@4.1.2/dist/css/bootstrap.min.css">
	<script type="text/javascript">
		function saveCaretPosition(editor){
			const selection = document.getSelection()
			const range = selection.getRangeAt(0)
			range.setStart(editor, 0)
			const len = range.toString().length

			return function restore(){
				const pos = getTextNodeAtPosition(editor, len)
				selection.removeAllRanges()
				const range = new Range()
				range.setStart(pos.node, pos.position)
				selection.addRange(range)
			}
		}

		function getTextNodeAtPosition(root, index){
			let lastNode = null

			const treeWalker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, function(e) {
				if(index >= e.textContent.length){
					index -= e.textContent.length
					lastNode = e
					return NodeFilter.FILTER_REJECT
				}
				return NodeFilter.FILTER_ACCEPT
			})
			const c = treeWalker.nextNode()
			return {
				node: c || root,
				position: c ? index : 0
			}
		}

		function getIndent(editor) {
			const restore = saveCaretPosition(editor)
			const range = document.getSelection().getRangeAt(0)
			range.setStart(editor, 0)
			const line = range.toString().split('\n').pop()
			restore()
			return /^(\s*)/g.exec(line)[1] || ''
		}

		function highLightMe(editor) {
			const restore = saveCaretPosition(editor)
			editor.innerHTML = Prism.highlight(editor.innerText || ' ', Prism.languages.javascript, 'javascript')
			restore()
		}

		const history = { pass: [], future: [], updownCache: null, zyCache: null }
		function onload() {
			const textarea = document.getElementById('script')
			const editor = document.getElementById('editor')
			const form = document.getElementById('form')
			const inputList = <%=JSON.stringify(_.map(_.filter(logs, ({ type }) => type === 'input'), 'content'))%>
			let inputListCursor = inputList.length
			const { pass, future } = history
			editor.addEventListener('keydown', function(e) {
				// console.log('keydown', e)
				if(e.keyCode == 9){ // tab
					document.execCommand('insertText', false, '	')
					e.preventDefault()
				} else if(e.ctrlKey && e.keyCode === 13) { // ctrl + enter
					form.script.value = this.innerText
					form.submit()
					e.preventDefault()
				} else if (e.ctrlKey && e.keyCode === 38) { // ctrl + up
					if (inputListCursor === inputList.length) {
						history.updownCache = this.innerText
					}
					inputListCursor = Math.max(0, inputListCursor - 1)
					this.innerText = inputList[inputListCursor]
					highLightMe(this)
				} else if (e.ctrlKey && e.keyCode === 40) { // ctrl + down
					inputListCursor = Math.min(inputListCursor + 1, inputList.length)
					this.innerText = inputListCursor === inputList.length ? history.updownCache || '\n' : inputList[inputListCursor]
					highLightMe(this)
				} else if (e.ctrlKey && e.keyCode === 90) { // ctrl + z
					e.preventDefault()
					if (!pass.length) {
						return
					}
					future.unshift(this.innerText)
					this.innerText = pass.pop()
					highLightMe(this)
				} else if (e.ctrlKey && e.keyCode === 89) { // ctrl + y
					e.preventDefault()
					if (!future.length) {
						return
					}
					pass.push(this.innerText)
					this.innerText = future.shift()
					highLightMe(this)
				} else if(e.keyCode == 13){ // enter
					const selection = document.getSelection()
					if (!selection.isCollapsed) {
						return
					}
					document.execCommand('insertText', false, '\n' + getIndent(this))
					e.preventDefault()
				}
			})
			editor.addEventListener('input', function(e) {
				// console.log('input', this.innerText)
				inputListCursor = inputList.length
				pass.push(history.zyCache)
				history.zyCache = this.innerText
				future.length = 0
				highLightMe(this)
			})
		}
	</script>
</head>
<body onload="onload()">
	<div class="row" style="background-color: darkslateblue; margin: 0;">
		<span style="margin: 8px auto; color: lightblue;">üíªÔ∏è NodeJS REPL</span>
	</div>
	<form action="" method="POST" class="form" id="form" style="background-color: black">
		<% _.forEach(logs, ({ timestamp, content, type }) => {%>
			<div class="row">
				<div class="col-1">
					<pre style="margin: 5px"><code style="color: lightgrey"><%=moment(timestamp).format('HH:mm:ss')%></code></pre>
				</div>
				<div class="col-11">
					<pre style="margin: 5px"><code style="color: <%=type==='input'?'lightblue':'lightgrey'%>"><%=_.escape(content)%></code></pre>
				</div>
			</div>
		<%})%>
		<textarea
			type="textarea"
			id="script"
			name="script"
			placeholder="Ctrl+Up/Down to browse history&#10Ctrl+Enter to submit your nodejs code&#10Submit empty to refresh"
			class="form-control"
			style="border-radius: 0"
			hidden
		></textarea>
	</form>
	<pre
		style="padding: .375rem .75rem; border: 1px solid lightgray; cursor: text; overflow: auto;"
		title="Ctrl+Up/Down to browse history&#10Ctrl+Enter to submit your nodejs code&#10Submit empty to refresh"
	><code id="editor" class="language-javascript" contenteditable="true" autofocus style="outline: none;">&#10</code></pre>
</body>
</html>
